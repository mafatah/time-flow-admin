# Email Reports Fix - Daily and Weekly Not Working

## Issues Identified

### 1. **Cron Job Configuration Issues**
- The `setup-automated-email-reports.sql` file contains placeholder values that need to be replaced
- Missing actual Supabase URL and Service Role Key values
- Cron jobs are not properly configured with real endpoints

### 2. **Backend Service Issues**
- `AutomatedReportsService` in backend is missing the `notificationsService` dependency
- The service is trying to call `this.notificationsService.sendEmailNotification()` but this service is not imported
- The backend approach conflicts with the Supabase Edge Function approach

### 3. **Environment Variable Issues**
- Missing or incorrect environment variables for Supabase
- RESEND_API_KEY not configured properly
- SERVICE_ROLE_KEY not set correctly

### 4. **Mixed Implementation Approaches**
- Both Supabase Edge Functions (working) and NestJS backend service (incomplete) are implemented
- This creates confusion and duplication of effort

## Current Working Components

✅ **Supabase Edge Function** (`supabase/functions/email-reports/index.ts`)
- Properly implemented with daily and weekly report generation
- Uses Resend API for email sending
- Has proper HTML template generation
- Includes test email functionality

✅ **Frontend Interface** (`src/pages/admin/email-reports.tsx`)
- Admin interface for managing email reports
- Can trigger manual reports

## Fix Implementation

### Step 1: Fix Cron Job Configuration

The main issue is that the cron jobs are not configured with real values. Here's what needs to be done:

1. **Get your Supabase URL and Service Role Key**
2. **Replace placeholders in the SQL file**
3. **Execute the corrected SQL**

### Step 2: Environment Variables Setup

Required environment variables:
```bash
# In your .env file
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
RESEND_API_KEY=your-resend-api-key
```

### Step 3: Database Setup

The system expects these tables:
- `users` (with admin role)
- `time_logs` 
- `projects`
- `screenshots`
- `app_logs`
- `url_logs`
- `report_types`
- `report_configurations`
- `report_recipients`

### Step 4: Verify Supabase Edge Function

The edge function should be deployed and accessible at:
- `https://your-project.supabase.co/functions/v1/email-reports/send-daily-report`
- `https://your-project.supabase.co/functions/v1/email-reports/send-weekly-report`

## Testing Steps

1. **Test Email Configuration**
   ```bash
   curl -X POST "https://your-project.supabase.co/functions/v1/email-reports/test-email" \
     -H "Authorization: Bearer your-service-role-key" \
     -H "Content-Type: application/json"
   ```

2. **Test Daily Report**
   ```bash
   curl -X POST "https://your-project.supabase.co/functions/v1/email-reports/send-daily-report" \
     -H "Authorization: Bearer your-service-role-key" \
     -H "Content-Type: application/json"
   ```

3. **Test Weekly Report**
   ```bash
   curl -X POST "https://your-project.supabase.co/functions/v1/email-reports/send-weekly-report" \
     -H "Authorization: Bearer your-service-role-key" \
     -H "Content-Type: application/json"
   ```

## Quick Fix - Automated Script

I've created an automated fix script that will:
- Check your environment variables
- Test your Supabase connection
- Test the edge functions
- Generate a configured SQL file
- Provide step-by-step instructions

### Run the Fix Script:
```bash
./fix-email-reports.sh
```

This script will:
1. ✅ Check all required environment variables
2. ✅ Test Supabase connection
3. ✅ Test edge function availability
4. ✅ Test daily and weekly report generation
5. ✅ Generate a personalized SQL file with your configuration
6. ✅ Provide next steps

### Files Created:
- `fix-email-reports.md` - This documentation
- `fix-email-reports.sh` - Automated fix script
- `setup-automated-email-reports-fixed.sql` - Fixed SQL template
- `setup-automated-email-reports-configured.sql` - Your personalized SQL file (generated by script)

## Manual Fix Steps

If you prefer to fix manually:

1. **Check Environment Variables**
   ```bash
   echo $VITE_SUPABASE_URL
   echo $SUPABASE_SERVICE_ROLE_KEY
   echo $RESEND_API_KEY
   ```

2. **Test Edge Function**
   ```bash
   curl -X POST "$VITE_SUPABASE_URL/functions/v1/email-reports/test-email" \
     -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
     -H "Content-Type: application/json"
   ```

3. **Update SQL File**
   - Open `setup-automated-email-reports-fixed.sql`
   - Replace `YOUR_SUPABASE_URL` with your actual Supabase URL
   - Replace `YOUR_SERVICE_ROLE_KEY` with your actual service role key
   - Run the updated SQL in your Supabase SQL Editor

4. **Verify Cron Jobs**
   ```sql
   SELECT jobname, schedule, command FROM cron.job WHERE jobname LIKE '%email%';
   ```

## Immediate Actions Needed

1. **Check your environment variables** - ensure all required variables are set
2. **Update the SQL file** with your actual Supabase URL and service key
3. **Run the corrected SQL** to set up the cron jobs
4. **Test the edge function** manually first
5. **Verify admin users exist** in your database

## Troubleshooting

### Common Issues:
- **"Environment variable not set"**: Check your .env file and restart services
- **"No admin users found"**: Ensure you have users with `role = 'admin'`
- **"Function timeout"**: Check database connectivity and data volume
- **"Email not sending"**: Verify RESEND_API_KEY is correct and active

### Log Checking:
- Check Supabase Function logs in your dashboard
- Look for cron job execution in Supabase SQL Editor
- Monitor the `pg_cron` extension logs

### Edge Function Deployment:
If the edge function is not working, you may need to redeploy it:
```bash
supabase functions deploy email-reports
```

## Backend Service Fix (Optional)

If you want to use the backend service instead of edge functions, you need to:
1. Install a notifications service (like Nodemailer)
2. Update the `AutomatedReportsService` to use the correct notification service
3. Configure the cron jobs to call the backend endpoints instead

However, **the edge function approach is recommended** as it's more complete and ready to use.

## Final Verification

After running the fix:
1. Check cron jobs are scheduled: `SELECT * FROM cron.job WHERE jobname LIKE '%email%';`
2. Monitor function logs in Supabase Dashboard
3. Wait for scheduled time or trigger manually
4. Check your email for test reports

## Summary

The main issue was that the cron jobs were configured with placeholder values instead of actual Supabase URLs and service keys. The fix script will automatically detect your configuration and generate the correct SQL to set up the automated email reports.

**Run `./fix-email-reports.sh` to get started!**